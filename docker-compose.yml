version: '3.8'

services:
  # 1. The VaultBridge Application
  app:
    image: vaultbridge-app:latest
    build: .
    container_name: vaultbridge_app
    restart: always
    ports:
      - "5050:5000" # Mapped to 5050 to avoid local port conflicts
    environment:
      - PORT=5000
      - NODE_ENV=production
      # This points to the 'db' service defined below
      - DATABASE_URL=postgresql://vaultuser:vaultpass@db:5432/vaultdb
      # CRITICAL: Tell the app to use local disk storage
      - STORAGE_PROVIDER=local
      - APP_URL=http://localhost:5050
      # Keep your existing email config
      - RESEND_API_KEY=${RESEND_API_KEY}
      - CONTACT_EMAIL=${CONTACT_EMAIL}
      - SMTP_FROM=${SMTP_FROM}
      # Placeholder Supabase creds to bypass strict initialization checks
      # (They are not used when STORAGE_PROVIDER=local)
      - SUPABASE_URL=http://placeholder-supabase-url
      - SUPABASE_SERVICE_ROLE_KEY=placeholder-key-for-local-mode
    volumes:
      # use named volume to avoid permission issues
      - vault_data_vol:/app/storage_data
    depends_on:
      - db

  # 2. The Local Database (PostgreSQL)
  db:
    image: postgres:15-alpine
    container_name: vaultbridge_db
    restart: always
    environment:
      - POSTGRES_USER=vaultuser
      - POSTGRES_PASSWORD=vaultpass
      - POSTGRES_DB=vaultdb
    volumes:
      # use named volume to avoid permission issues
      - postgres_data_vol:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  postgres_data_vol:
  vault_data_vol:
